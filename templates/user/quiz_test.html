{% extends 'user/assets/base.html' %}

{% block title %}Quiz Participation{% endblock %}

{% block stylesheet %}  
<style>
    .active {
        background-color: rgb(86, 86, 86) !important;
    }
    .selected {
        background-color: #e0ffe0;
    }
    .nav-link {
        margin: 5px 0;
        padding: 10px;
        border-radius: 5px;
        text-align: center;
    }
    .card {
        margin-bottom: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .card-body {
        padding: 20px;
    }
    .drag-drop-zone {
        border: 2px dashed #ccc;
        border-radius: 5px;
        padding: 10px;
        margin-top: 10px;
        text-align: center;
        min-height: 50px;
        margin-bottom: 10px;
    }
    .drag-drop-zone.drag-over {
        border-color: #33d17a;
    }
    .option-label {
        display: inline-block;
        margin: 5px;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        background-color: #f9f9f9;
        cursor: pointer;
    }
    .incorrect-box {
        border: 2px dashed #f00;
        border-radius: 5px;
        padding: 10px;
        margin-top: 10px;
        text-align: center;
        min-height: 50px;
        margin-bottom: 10px;
    }

    body, html {
        height: 100%;
        margin: 0;
        padding: 0;
    }

    .full-page {
        height: 70vh;
        display: flex;
        flex-direction: column;
    }

    #quiz_page {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
    }

    .card-body {
        overflow-y: auto;
        max-height: 100%;
    }

    .fixed-bottom {
        position: fixed;
        bottom: 0;
        width: 100%;
    }


</style>
{% endblock %}

{% load custom_filters %}
{% load static %}

{% block content %}

<div class="p-3" style="background-color: #0018a9; border-radius: 8px;" id="quiz_page">

    <div class="mb-2 d-flex">
        <img src="{% static '/logo/londonseru_logo.png' %}" style="height:35px" alt="" srcset="">
        <p id="dateTime" class="mt-2 ml-2" style="color: #ffffff;"></p>
    </div>
    

    <form id="quizForm" action="{% url 'core:submit_answer' %}" method="post">
    {% csrf_token %}


        <div class="">
            <div class="">
                <div class="col-12" style="display: none;">
                    <ul class="nav flex-column nav-pills" id="questionTab" role="tablist">
                        <div class="row justify-content-center text-center">
                            {% for question in questions %}
                                <div class="col-2">
                                    <li class="nav-item">
                                        <a style="padding: 3px; background-color: #0018a9; color: #ffffff; border: 1px solid none;" class="nav-link font-weight-bold {% if forloop.first %}active{% endif %}" id="questionTab{{ forloop.counter }}-tab" data-toggle="pill" href="#question{{ forloop.counter }}" role="tab" aria-controls="question{{ forloop.counter }}" aria-selected="{% if forloop.first %}true{% else %}false{% endif %}">{{ forloop.counter }}</a>
                                    </li>
                                </div>
                            {% endfor %}                      
                        </div>
                    </ul>
                </div>
                <div class="col-12">
                    <input type="hidden" name="q_pattern" value="{{ q_pattern.id }}">
                    <div class="tab-content" id="questionTabContent">
                        {% for question in questions %}
                            <div class="tab-pane fade {% if forloop.first %}show active{% endif %}" id="question{{ forloop.counter }}" role="tabpanel" aria-labelledby="questionTab{{ forloop.counter }}-tab">
                                <input type="hidden" name="question_{{ forloop.counter }}" value="{{ question.id }}">
                                <div class="card full-page">
                                    <div class="card-body">
                                        <p class="mb-2">
                                            <strong>Question {{ forloop.counter }} of {{ questions|length }}:</strong>
                                        </p>
                                        {% if question.question_type == 'drag_and_drop' %}
                                            <input type="hidden" name="drag_and_drop_{{ question.id }}" id="dragAndDropAnswer{{ question.id }}">
                                            <p class="mb-2"><strong>{{ question.draganddropquestion.question_text }}</strong></p>
                                            <div class="row mb-3">
                                                <div class="col-10">
                                                    <p class="mb-2">
                                                        <strong class="sentence-to-complete" id="sentence{{ forloop.counter }}">
                                                            {{ question.draganddropquestion.sentence_to_complete }}
                                                        </strong>
                                                    </p>
                                                </div>
                                                <div class="col-2">
                                                    <i class="fe fe-clock fe-16"></i>
                                                    <span id="timer{{ forloop.counter }}"></span>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-md-4">
                                                    {% for option in question.draganddropquestion.options.all %}
                                                    <div class="option-label border-dark" draggable="true" id="{{ option.id }}" data-option-id="{{ option.id }}">{{ option.option_text }}</div>
                                                    {% endfor %}
                                                </div>
                                                <div class="col-md-8">
                                                    <div class="card mt-3">
                                                        <div class="card-body" style="background-color: rgba(255, 97, 97, 0.37); border-radius: 10px;">
                                                            <h6 class="card-title">Incorrect Words</h6>
                                                            <div class="incorrect-box drag-drop-zone" data-item-id="" id="incorrectBox{{ forloop.counter }}"></div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
        
                                        {% elif question.question_type == 'multiple_choice' %}
                                            <div class="row mb-3">
                                                <div class="col-10">
                                                    <p class="mb-2"><strong>{{ question.multiplechoicequestion.question_text }}</strong></p>
                                                </div>
                                                <div class="col-2">
                                                    <i class="fe fe-clock fe-16"></i>
                                                    <span id="timer{{ forloop.counter }}"></span>
                                                </div>
                                            </div>
                                            {% for option in question.multiplechoicequestion.options.all %}
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="option_{{ question.id }}[]" id="option{{ forloop.counter }}" value="{{ option }}">
                                                    <label class="form-check-label" for="option{{ forloop.counter }}">{{ option }}</label>
                                                </div>
                                            {% endfor %}
                                        {% elif question.question_type == 'single_choice' %}
                                            <div class="row mb-3">
                                                <div class="col-10">
                                                    <p class="mb-2"><strong>{{ question.singlechoicequestion.question_text }}</strong></p>
                                                </div>
                                                <div class="col-2">
                                                    <i class="fe fe-clock fe-16"></i>
                                                    <span id="timer{{ forloop.counter }}"></span>
                                                </div>
                                            </div>
                                            {% for option in question.singlechoicequestion.options.all %}
                                                <div class="form-check">
                                                    <input class="form-check-input" type="radio" name="option_{{ question.id }}" id="option{{ forloop.counter }}" value="{{ option.option_text }}">
                                                    <label class="form-check-label" for="option{{ forloop.counter }}">{{ option.option_text }}</label>
                                                </div>
                                            {% endfor %}
                                            {% elif question.question_type == 'dropdown' %}
                                                <div class="row mb-3">
                                                    <div class="col-10">
                                                        <p class="mb-2"><strong>{{ question.dropdownquestion.question_text|replace_underscores_with_dropdown:question.dropdownquestion.dropdown_items.all|safe }}</strong></p>
                                                    </div>
                                                    <div class="col-2">
                                                        <i class="fe fe-clock fe-16"></i>
                                                        <span id="timer{{ forloop.counter }}"></span>
                                                    </div>
                                                </div>
                                            {% endif %}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <div class="fixed-bottom p-3 bg-white" style="box-shadow: 0 -2px 10px rgba(0,0,0,0.1);">
            <div class="d-flex justify-content-between">
                <button type="button" class="btn btn-outline-secondary text-dark" id="previousButton" disabled>Previous</button>
                <button type="button" class="btn btn-outline-secondary text-dark" id="nextButton">Next</button>
                <button type="submit" class="btn" style="background-color: #0018a9; color:white">Submit Quiz</button>
            </div>
        </div>

    </form>        



</div>

{% endblock %}

{% block script %}
<script>

function updateDateTime() {
    const now = new Date();
    const options = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' };
    const formattedDate = now.toLocaleDateString('en-GB', options);  // Adjust locale as needed
    const userName = "{{ request.user }}";  // Ensure this Django variable is available in the template
    document.getElementById('dateTime').textContent = `${formattedDate} | Logged in as ${userName}`;
}

// Call updateDateTime when the page loads
window.onload = updateDateTime;

// Optionally, update the time every second
setInterval(updateDateTime, 1000);



document.body.classList.add('collapsed');
document.getElementById('collapseBtn').disabled = true;


document.addEventListener("DOMContentLoaded", function() {

    // Get the quiz page element and the fullscreen button
    const element = document.getElementById('quiz_page');
    const fullscreenButton = document.getElementById('fullscreenButton');
    const questionContainer = document.getElementById('quiz_page');


    var nextButton = document.getElementById('nextButton');
    var previousButton = document.getElementById('previousButton');

    function updateButtonState() {
        var activeTab = document.querySelector('#questionTab a.active');
        var tabs = Array.from(document.querySelectorAll('#questionTab a'));
        var activeIndex = tabs.indexOf(activeTab);

        previousButton.disabled = activeIndex === 0;
        nextButton.disabled = activeIndex === tabs.length - 1;
    }

    function navigateTabs(direction) {
        var activeTab = document.querySelector('#questionTab a.active');
        var tabs = Array.from(document.querySelectorAll('#questionTab a'));
        var activeIndex = tabs.indexOf(activeTab);
        var newIndex = activeIndex + direction;

        if (newIndex >= 0 && newIndex < tabs.length) {
            tabs[newIndex].click();
        }
    }

    nextButton.addEventListener('click', function() {
        navigateTabs(1);
        updateButtonState();
    });

    previousButton.addEventListener('click', function() {
        navigateTabs(-1);
        updateButtonState();
    });

    // Initialize button state
    updateButtonState();

    function startCountdown(duration, display) {
        var timer = duration * 60, minutes, seconds;

        var form = document.getElementById('quizForm');

        var countdownInterval = setInterval(function () {
            minutes = parseInt(timer / 60, 10);
            seconds = parseInt(timer % 60, 10);

            minutes = minutes < 10 ? "0" + minutes : minutes;
            seconds = seconds < 10 ? "0" + seconds : seconds;

            display.textContent = minutes + ":" + seconds;

            if (--timer < 0) {
                clearInterval(countdownInterval); 
                form.submit();
            }
        }, 1000);
    }

    var timerDisplays = document.querySelectorAll('[id^="timer"]');
    var durationInMinutes = parseInt('{{ q_pattern.exam_duration }}');

    timerDisplays.forEach(function(display, index) {
        startCountdown(durationInMinutes, display);
    });

    function createDropZones(text) {
        var words = text.split(' ');

        var html = '';
        words.forEach(function(word, index) {
            if (word === '____') {
                html += `<span class="drag-drop-zone" draggable="true" id="dragDropZone${index + 1}" data-answer="">____</span> `;
            } else {
                html += `<span>${word}</span> `;
            }
            html += ' ';
        });

        return html.trim();
    }

    var sentenceToComplete = document.querySelectorAll('.sentence-to-complete');

    sentenceToComplete.forEach(function(sentence) {
        var sentenceText = sentence.textContent.trim();
        sentence.innerHTML = createDropZones(sentenceText);
    });

    function initializeDragAndDrop(container) {
        var dragDropZones = container.querySelectorAll('.drag-drop-zone');
        var draggableItems = container.querySelectorAll('.option-label');
        var incorrectBoxes = container.querySelectorAll('.incorrect-box');

        // Store original positions
        var originalPositions = {};

        draggableItems.forEach(function(item) {
            originalPositions[item.id] = item.parentNode;
            item.setAttribute('draggable', 'true');
        });

        // Add event listeners for draggable items
        draggableItems.forEach(function(item) {
            item.addEventListener('dragstart', function(event) {
                event.dataTransfer.setData("text/plain", event.target.id);
            });
        });

        // Add event listeners for drag drop zones
        dragDropZones.forEach(function(zone) {
            zone.addEventListener('dragover', function(event) {
                event.preventDefault();
                zone.classList.add('drag-over');
            });

            zone.addEventListener('dragleave', function() {
                zone.classList.remove('drag-over');
            });

            zone.addEventListener('drop', function(event) {
                event.preventDefault();
                zone.classList.remove('drag-over');

                var data = event.dataTransfer.getData("text/plain");
                var draggedElement = document.getElementById(data);

                if (zone.textContent.trim() === '____') {
                    zone.textContent = draggedElement.textContent;
                    zone.dataset.itemId = draggedElement.id;
                    draggedElement.style.display = 'none';

                    // Allow item to be returned to original position on click
                    zone.addEventListener('dragend', function() {
                        if (zone.dataset.itemId) {
                            var item = document.getElementById(zone.dataset.itemId);
                            item.style.display = 'inline-block';
                            originalPositions[item.id].appendChild(item);
                            zone.textContent = '____';
                            delete zone.dataset.itemId;
                        }
                    });
                } else {
                    // If the drop zone is occupied, move the item to the incorrect box
                    findParentIncorrectBox(zone).appendChild(draggedElement);
                    draggedElement.style.display = 'inline-block';
                }
            });
        });

        // Add event listeners for incorrect boxes
        incorrectBoxes.forEach(function(incorrectBox) {
            incorrectBox.addEventListener('dragover', function(event) {
                event.preventDefault();
                incorrectBox.classList.add('drag-over');
            });

            incorrectBox.addEventListener('dragleave', function() {
                incorrectBox.classList.remove('drag-over');
            });

            incorrectBox.addEventListener('drop', function(event) {
                event.preventDefault();
                incorrectBox.classList.remove('drag-over');

                var data = event.dataTransfer.getData("text/plain");
                var draggedElement = document.getElementById(data);
                incorrectBox.appendChild(draggedElement);
                draggedElement.style.display = 'inline-block';

                // Allow item to be returned to original position on click
                draggedElement.addEventListener('dragleave', function() {
                    originalPositions[draggedElement.id].appendChild(draggedElement);
                });
            });
        });

        // Function to find the parent incorrect box of a given element
        function findParentIncorrectBox(element) {
            var parent = element.parentNode;
            console.log("Printing Parent:");
            console.log(parent);
            while (parent) {
                console.log(parent.classList);
                if (parent.classList.contains('incorrect-box')) {
                    return parent;
                }
                parent = parent.parentNode;
            }
            return null;
        }
    }


        // Initialize drag and drop for each tab pane
        document.querySelectorAll('.tab-pane').forEach(function(tabPane) {
            initializeDragAndDrop(tabPane);
        });


    // Tab switching logic
    var questionTabs = document.querySelectorAll('#questionTab a');
    var tabContents = document.querySelectorAll('.tab-pane');

    questionTabs.forEach(function(tab) {
        tab.addEventListener('click', function(event) {
            event.preventDefault();
            var target = document.querySelector(tab.getAttribute('href'));

            questionTabs.forEach(function(tab) {
                tab.classList.remove('active');
            });

            tabContents.forEach(function(content) {
                content.classList.remove('show', 'active');
            });

            tab.classList.add('active');
            target.classList.add('show', 'active');

            updateButtonState();
        });
    });
});
</script>


<script>
document.addEventListener('DOMContentLoaded', function() {
    var quizForm = document.getElementById('quizForm');
    quizForm.addEventListener('submit', function(event) {
        
        document.querySelectorAll('input[name^="drag_and_drop_"]').forEach(function(input) {
            input.remove();
        });

        document.querySelectorAll('.tab-pane').forEach(function(tabPane) {
            var questionId = tabPane.querySelector('input[type="hidden"]').value;
            var dragDropZones = tabPane.querySelectorAll('.drag-drop-zone');
            var selectedAnswers = [];

            dragDropZones.forEach(function(zone) {
                var answer = zone.dataset.itemId;
                if (answer) {
                    selectedAnswers.push(parseInt(answer)); 
                }
            });

            if (selectedAnswers.length > 0) {
                var input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'drag_and_drop_' + questionId;
                input.value = JSON.stringify(selectedAnswers);
                quizForm.appendChild(input);
            }
        });

    });
});

</script>

{% endblock %}